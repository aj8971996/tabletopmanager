<div class="attribute-manager-container">
  <!-- Header Section -->
  <header class="manager-header">
    <div class="header-content">
      <div class="title-section">
        <mat-icon class="header-icon">tune</mat-icon>
        <div class="title-info">
          <h1>Attribute Management</h1>
          <p class="subtitle">Define character stats and calculations for {{ currentGameSpace()?.name }}</p>
        </div>
      </div>
      
      <div class="header-actions">
        @if (dynamicAttributes().length > 0) {
          <button 
            mat-stroked-button 
            color="primary"
            (click)="toggleTemplates()"
            class="template-toggle">
            <mat-icon>{{ showTemplates() ? 'expand_less' : 'auto_awesome' }}</mat-icon>
            <span>{{ showTemplates() ? 'Hide Templates' : 'Use Template' }}</span>
          </button>
        }
      </div>
    </div>
  </header>

  <!-- Loading State -->
  @if (isLoading()) {
    <div class="loading-container">
      <mat-spinner diameter="40"></mat-spinner>
      <p>Loading attributes...</p>
    </div>
  }

  <!-- Getting Started / Templates Section -->
  @if (dynamicAttributes().length === 0 || showTemplates()) {
    <section class="templates-section" [class.collapsible]="dynamicAttributes().length > 0">
      <mat-card class="templates-card">
        <mat-card-header>
          <div class="templates-header">
            <div class="templates-title">
              <mat-icon>auto_awesome</mat-icon>
              <h2>{{ dynamicAttributes().length === 0 ? 'Quick Start with Templates' : 'Attribute Templates' }}</h2>
            </div>
            @if (dynamicAttributes().length > 0) {
              <button mat-icon-button (click)="toggleTemplates()" matTooltip="Close templates">
                <mat-icon>close</mat-icon>
              </button>
            }
          </div>
        </mat-card-header>
        
        <mat-card-content>
          <p class="templates-description">
            {{ dynamicAttributes().length === 0 
              ? 'Choose a proven attribute system to get started quickly, or create custom attributes from scratch.'
              : 'Add a pre-built attribute system to supplement your existing attributes.' }}
          </p>
          
          <div class="templates-grid">
            @for (template of attributeTemplates; track template.name) {
              <div 
                class="template-card"
                [class.selected]="selectedTemplate()?.name === template.name"
                (click)="onSelectTemplate(template)">
                
                <div class="template-header">
                  <h3>{{ template.label }}</h3>
                  <span class="template-type">{{ template.attributes.length }} attributes</span>
                </div>
                
                <div class="template-attributes">
                  @for (attr of template.attributes; track attr.name) {
                    <span class="attribute-chip">{{ attr.label }}</span>
                  }
                </div>
                
                <div class="template-preview">
                  <span class="preview-range">Range: {{ template.attributes[0].min }}-{{ template.attributes[0].max }}</span>
                  <span class="preview-default">Default: {{ template.attributes[0].default }}</span>
                </div>
              </div>
            }
          </div>

          @if (selectedTemplate()) {
            <div class="template-actions">
              <button mat-button (click)="clearSelectedTemplate()">Cancel</button>
              <button mat-raised-button color="primary" (click)="onApplyTemplate()">
                <mat-icon>check</mat-icon>
                Apply {{ selectedTemplate()!.label }}
              </button>
            </div>
          }
        </mat-card-content>
      </mat-card>
    </section>
  }

  <!-- Main Content -->
  @if (!isLoading()) {
    <div class="main-content" [class.single-column]="dynamicAttributes().length === 0">
      
      <!-- Attribute Form -->
      <section class="form-section">
        <mat-card class="form-card">
          <mat-card-header>
            <div class="form-header">
              <div class="form-title">
                <mat-icon>{{ editingAttribute() ? 'edit' : 'add' }}</mat-icon>
                <h2>{{ editingAttribute() ? 'Edit' : 'Create' }} Attribute</h2>
              </div>
              @if (editingAttribute()) {
                <button mat-icon-button (click)="cancelEdit()" matTooltip="Cancel editing">
                  <mat-icon>close</mat-icon>
                </button>
              }
            </div>
          </mat-card-header>
          
          <mat-card-content>
            <form [formGroup]="attributeForm" class="attribute-form">
              <!-- Basic Info -->
              <div class="form-section-group">
                <div class="form-row">
                  <mat-form-field appearance="outline">
                    <mat-label>Attribute Code</mat-label>
                    <input 
                      matInput 
                      formControlName="attribute_name" 
                      placeholder="STR" 
                      maxlength="20">
                    <mat-hint>Uppercase letters and underscores only</mat-hint>
                    @if (getAttributeNameError()) {
                      <mat-error>{{ getAttributeNameError() }}</mat-error>
                    }
                  </mat-form-field>

                  <mat-form-field appearance="outline">
                    <mat-label>Display Name</mat-label>
                    <input 
                      matInput 
                      formControlName="attribute_label" 
                      placeholder="Strength" 
                      maxlength="100">
                    <mat-hint>Human-readable name for players</mat-hint>
                    @if (attributeForm.get('attribute_label')?.hasError('required')) {
                      <mat-error>Display name is required</mat-error>
                    }
                  </mat-form-field>
                </div>

                <mat-form-field appearance="outline" class="full-width">
                  <mat-label>Description</mat-label>
                  <textarea 
                    matInput 
                    formControlName="description" 
                    rows="2" 
                    maxlength="500"
                    placeholder="What does this attribute represent?"></textarea>
                  <mat-hint>Optional explanation for players</mat-hint>
                </mat-form-field>
              </div>

              <!-- Values Configuration -->
              <div class="form-section-group">
                <h4 class="section-label">Value Configuration</h4>
                
                <div class="values-row">
                  <mat-form-field appearance="outline">
                    <mat-label>Minimum</mat-label>
                    <input 
                      matInput 
                      formControlName="min_value" 
                      type="number" 
                      min="0">
                  </mat-form-field>

                  <mat-form-field appearance="outline">
                    <mat-label>Maximum</mat-label>
                    <input 
                      matInput 
                      formControlName="max_value" 
                      type="number" 
                      min="1">
                  </mat-form-field>

                  <mat-form-field appearance="outline">
                    <mat-label>Default</mat-label>
                    <input 
                      matInput 
                      formControlName="base_value" 
                      type="number" 
                      min="1">
                  </mat-form-field>
                </div>

                @if (getMinMaxError()) {
                  <div class="form-error">
                    <mat-icon>error</mat-icon>
                    <span>{{ getMinMaxError() }}</span>
                  </div>
                }
              </div>

              <!-- Additional Options -->
              <div class="form-section-group">
                <div class="form-row">
                  <mat-form-field appearance="outline">
                    <mat-label>Calculation Type</mat-label>
                    <mat-select formControlName="calculation_type">
                      <mat-option value="static">Static Value</mat-option>
                      <mat-option value="calculated" disabled>Calculated (Coming Soon)</mat-option>
                    </mat-select>
                  </mat-form-field>

                  <mat-form-field appearance="outline">
                    <mat-label>Display Order</mat-label>
                    <input 
                      matInput 
                      formControlName="display_order" 
                      type="number" 
                      min="0">
                    <mat-hint>0 = first</mat-hint>
                  </mat-form-field>
                </div>

                <div class="toggle-row">
                  <mat-slide-toggle 
                    formControlName="is_core_stat"
                    color="primary">
                    <span class="toggle-label">
                      <mat-icon>star</mat-icon>
                      Core Attribute
                    </span>
                  </mat-slide-toggle>
                  <span class="toggle-hint">Core attributes appear prominently on character sheets</span>
                </div>
              </div>

              <!-- Form Actions -->
              <div class="form-actions">
                @if (editingAttribute()) {
                  <button mat-button type="button" (click)="cancelEdit()">Cancel</button>
                  <button 
                    mat-raised-button 
                    color="primary" 
                    type="button"
                    [disabled]="!isFormValid()"
                    (click)="onUpdateAttribute()">
                    <mat-icon>save</mat-icon>
                    Update Attribute
                  </button>
                } @else {
                  <button 
                    mat-raised-button 
                    color="primary" 
                    type="button"
                    [disabled]="!isFormValid()"
                    (click)="onCreateAttribute()">
                    <mat-icon>add</mat-icon>
                    Create Attribute
                  </button>
                }
              </div>
            </form>
          </mat-card-content>
        </mat-card>
      </section>

      <!-- Attributes List -->
      <section class="attributes-section">
        <mat-card class="attributes-card">
          <mat-card-header>
            <div class="attributes-header">
              <div class="attributes-title">
                <mat-icon>list</mat-icon>
                <h2>Current Attributes</h2>
                <span class="count-badge">({{ dynamicAttributes().length }})</span>
              </div>
              
              @if (dynamicAttributes().length > 3) {
                <form [formGroup]="searchForm" class="search-form">
                  <mat-form-field appearance="outline" class="search-field">
                    <mat-label>Search attributes</mat-label>
                    <input matInput formControlName="search" placeholder="Type to filter...">
                    <mat-icon matSuffix>search</mat-icon>
                  </mat-form-field>
                </form>
              }
            </div>
          </mat-card-header>

          <mat-card-content>
            @if (dynamicAttributes().length === 0) {
              <div class="empty-state">
                <div class="empty-icon">
                  <mat-icon>tune</mat-icon>
                </div>
                <h3>No Attributes Yet</h3>
                <p>Create your first attribute using the form, or choose a template above to get started quickly.</p>
              </div>
            } @else {
              <!-- Attributes Grid -->
              <div class="attributes-grid" cdkDropList (cdkDropListDropped)="onDrop($event)">
                @for (attribute of dynamicAttributes(); track attribute.id) {
                  <div class="attribute-card" cdkDrag [cdkDragData]="attribute">
                    <!-- Drag Handle -->
                    <div class="drag-handle" cdkDragHandle>
                      <mat-icon>drag_indicator</mat-icon>
                    </div>

                    <!-- Card Content -->
                    <div class="card-content">
                      <div class="attribute-header">
                        <div class="attribute-identity">
                          <span class="attribute-code">{{ attribute.attribute_name }}</span>
                          <h3 class="attribute-name">{{ attribute.attribute_label }}</h3>
                          @if (attribute.is_core_stat) {
                            <span class="core-badge">
                              <mat-icon>star</mat-icon>
                              Core
                            </span>
                          }
                        </div>
                        
                        <div class="attribute-actions">
                          <button 
                            mat-icon-button 
                            (click)="onEditAttribute(attribute)"
                            matTooltip="Edit attribute">
                            <mat-icon>edit</mat-icon>
                          </button>
                          <button 
                            mat-icon-button 
                            [matMenuTriggerFor]="actionMenu"
                            matTooltip="More actions">
                            <mat-icon>more_vert</mat-icon>
                          </button>

                          <mat-menu #actionMenu="matMenu">
                            <button mat-menu-item (click)="onDeleteAttribute(attribute)">
                              <mat-icon>delete</mat-icon>
                              <span>Delete</span>
                            </button>
                          </mat-menu>
                        </div>
                      </div>

                      @if (attribute.description) {
                        <p class="attribute-description">{{ attribute.description }}</p>
                      }

                      <div class="attribute-details">
                        <div class="detail-group">
                          <span class="detail-label">Range</span>
                          <span class="detail-value range">{{ attribute.min_value }}â€“{{ attribute.max_value }}</span>
                        </div>
                        <div class="detail-group">
                          <span class="detail-label">Default</span>
                          <span class="detail-value default">{{ attribute.base_value }}</span>
                        </div>
                        <div class="detail-group">
                          <span class="detail-label">Type</span>
                          <span class="detail-value type">
                            <mat-icon>{{ getAttributeTypeIcon(attribute.calculation_type) }}</mat-icon>
                            {{ getAttributeTypeLabel(attribute.calculation_type) }}
                          </span>
                        </div>
                      </div>
                    </div>
                  </div>
                }
              </div>

              <!-- Summary Stats -->
              <div class="attributes-summary">
                <div class="summary-item">
                  <mat-icon>tune</mat-icon>
                  <span>{{ dynamicAttributes().length }} Total Attributes</span>
                </div>
                <div class="summary-item">
                  <mat-icon>star</mat-icon>
                  <span>{{ coreAttributes().length }} Core Attributes</span>
                </div>
              </div>
            }
          </mat-card-content>
        </mat-card>
      </section>
    </div>
  }
</div>